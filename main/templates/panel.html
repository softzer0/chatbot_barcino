{% extends "base_generic.html" %}

{% block title %}Panel{% endblock %}

{% block extra_styles %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: Arial, sans-serif;
        background-color: #f4f6f8;
    }

    .panel-body {
        border: 1px solid #007bff;
        border-top: none;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,.26);
        background-color: white;
        padding: 15px;
        overflow-y: auto;
    }

    .question {
        display: inline-block;
        background-color: #a9a9a9;
        border-radius: 12px;
        padding: 10px;
        margin-bottom: 5px;
        word-break: break-all;
    }

    .answer {
        display: inline-block;
        background-color: #0e86fe;
        color: white;
        border-radius: 12px;
        padding: 10px;
        margin-bottom: 5px;
    }

    .list-group-item {
        cursor: pointer;
        margin-bottom: 10px;
    }

    .list-group-item.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .session-info {
        border: 1px solid #007bff;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,.26);
        background-color: white;
        margin-top: 20px;
        padding: 15px;
    }

    .truncate {
        line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .badge {
        white-space: break-spaces;
        text-align: left;
    }

    .new-message {
        background-color: #ffd700;
    }

    .h-100 {
        height: 100vh !important;
    }

    .flex-grow-1 {
        flex-grow: 1;
        overflow: hidden;
    }

    .panel-wrapper {
        height: 100%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .panel-content {
        flex: 1 1 auto;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100 d-flex flex-column">
    <div class="row flex-grow-1 overflow-hidden">
        <div class="col-md-4 panel-wrapper">
            <h5>Chat Sessions</h5>
            <div class="list-group panel-content" id="session-list"></div>
        </div>
        <div class="col-md-4 panel-wrapper">
            <h5>Chat Session</h5>
            <div id="chat-session" class="panel-body panel-content"></div>
        </div>
        <div class="col-md-4 panel-wrapper">
            <h5>Information</h5>
            <div id="info-pane" class="panel-content">
                Name: <br/>
                Contact number: <br/>
                Arrangement: <br/>
            </div>
        </div>
    </div>
</div>

<template id="session-template">
    <a href="#" class="list-group-item list-group-item-action truncate"></a>
</template>

<template id="message-template">
    <div class="card">
        <div class="card-body">
            <span class="badge question"></span><br>
            <span class="badge answer"></span>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_scripts %}
<script>
    $(function () {
        var socket = new WebSocket('ws://localhost:8000/ws/panel/');
        var activeSession = null;
        var pendingSessionMessages = {};

        socket.onopen = function(event) {
            socket.send(JSON.stringify({ command: 'fetch_sessions' }));
        };

        function appendElement(id, template, parent, settings) {
            if (!$(`#${id}`).length) {
                let templateElement = document.querySelector(`#${template}`);
                let clone = templateElement.content.cloneNode(true);
                settings(clone);
                $(`#${parent}`).append(clone);
            }
        }

        function putSessionName(link, session_id, message) {
            link.textContent = `#${session_id} - ${message}`;
        }

        function appendSession(session) {
            appendElement(`session-${session.id}`, 'session-template', 'session-list', function(clone) {
                let link = clone.querySelector('a');
                link.id = `session-${session.id}`;
                link.onclick = function() { fetchMessages(session.id); };
                if (activeSession === session.id) {
                    link.classList.add('active');
                }

                // If there is a newer pending message for this session, use it
                if (pendingSessionMessages[session.id]) {
                    session.last_message = pendingSessionMessages[session.id].message;
                    delete pendingSessionMessages[session.id];
                }

                putSessionName(link, session.id, session.last_message);
            });
        }

        function appendMessage(message) {
            // Store the message in the pendingSessionMessages map, overwriting any previous message
            pendingSessionMessages[message.session_id] = message;

            // If the session for this message does not exist yet, return
            if (!$(`#session-${message.session_id}`).length) {
                return;
            }

            appendElement(`message-${message.id}`, 'message-template', 'chat-session', function(clone) {
                let card = clone.querySelector('.card');
                card.id = `message-${message.id}`;
                let question = card.querySelector('.question');
                question.textContent = message.message;
                let answer = card.querySelector('.answer');
                answer.textContent = message.response;

                // Scroll to bottom when a new message is appended
                $('#chat-session').scrollTop($('#chat-session')[0].scrollHeight);
            });

            if ($(`#session-${message.session_id}`).length) {
                let sessionLink = $(`#session-${message.session_id}`);
                putSessionName(sessionLink, message.message);
            }
        }

        socket.onmessage = function(event) {
            var data = JSON.parse(event.data);

            // handle incoming new sessions
            if (data.command === 'new_session') {
                appendSession(data.session);
            }

            // handle incoming new messages
            else if (data.command === 'new_message') {
                var message = data.message;

                // Always update pending message and session name with new message
                pendingSessionMessages[message.session_id] = message;
                let sessionLink = $(`#session-${message.session_id}`);
                if (sessionLink.length) {
                    putSessionName(sessionLink[0], message.session_id, message.message);
                    sessionLink.addClass('new-message');
                }

                // Append message to chat only if it's for the active session
                if (message.session_id === activeSession) {
                    appendMessage(message);
                }
            }

            // handle fetched sessions
            else if (data.command === 'fetch_sessions') {
                data.sessions.forEach(appendSession);
            }

            // handle fetched messages
            else if (data.command === 'fetch_messages') {
                data.messages.forEach(appendMessage);
            } else {
                console.error("Unrecognized command:", data.command);
            }
        };

        socket.onclose = function(event) {
            console.log('Socket closed connection: ', event);
        };

        socket.onerror = function(error) {
            console.log('Socket error: ', error);
        };

        window.fetchMessages = function(sessionId) {
            activeSession = sessionId;
            $('.list-group-item').removeClass('active');
            $(`#session-${sessionId}`).addClass('active');
            $(`#session-${sessionId}`).removeClass('new-message');
            // Clear the chat session before loading new messages
            $('#chat-session').html('');
            socket.send(JSON.stringify({ command: 'fetch_messages', session_id: sessionId }));
        };
    });
</script>
{% endblock %}
